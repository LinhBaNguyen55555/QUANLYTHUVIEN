@model QUANLYTHUVIEN.Models.Book
@using QUANLYTHUVIEN.Utilities
@using QUANLYTHUVIEN.Models
@using System.Linq
@{
    ViewData["Title"] = Model.Title;
    var alias = Function.TitleSlugGenerationAlias(Model.Title);
    var currentPrice = ViewBag.CurrentRentalPrice as QUANLYTHUVIEN.Models.RentalPrice;
    var relatedBooks = ViewBag.BooksRelated as List<QUANLYTHUVIEN.Models.Book>;
    var availableQuantity = ViewBag.AvailableQuantity ?? 0;
    var totalQuantity = Model.Quantity ?? 0;
    
    // Xử lý reviews an toàn
    List<BookReview> reviews = new List<BookReview>();
    if (ViewBag.Reviews != null && ViewBag.Reviews is IEnumerable<BookReview>)
    {
        reviews = (ViewBag.Reviews as IEnumerable<BookReview>)?.ToList() ?? new List<BookReview>();
    }
    
    var reviewCount = ViewBag.ReviewCount != null ? (int)ViewBag.ReviewCount : 0;
    var averageRating = ViewBag.AverageRating != null ? (double)ViewBag.AverageRating : 0.0;
    var canReview = ViewBag.CanReview != null && (bool)ViewBag.CanReview;
}

<!-- Start: Page Banner -->
<section class="page-banner services-banner">
    <div class="container">
        <div class="banner-header">
            <h2>Chi Tiết Sách</h2>
            <span class="underline center"></span>
            <p class="lead">Thông tin chi tiết về cuốn sách</p>
        </div>
        <div class="breadcrumb">
            <ul>
                <li><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                <li>Sách</li>
            </ul>
        </div>
    </div>
</section>
<!-- End: Page Banner -->

<!-- Start: Products Section -->
<div id="content" class="site-content">
    <div id="primary" class="content-area">
        <main id="main" class="site-main">
            <div class="booksmedia-detail-main">
                <div class="container">
                    <div class="row">
                        <!-- Start: Search Section -->
                        <section class="search-filters">
                            <div class="container">
                                <div class="filter-box">
                                    <h3>Bạn đang tìm kiếm gì tại thư viện?</h3>
                                    <form action="@Url.Action("Search", "Home")" method="get">
                                        <div class="col-md-4 col-sm-6">
                                            <div class="form-group">
                                                <label class="sr-only" for="keywords">Tìm kiếm theo từ khóa</label>
                                                <input class="form-control" placeholder="Tìm kiếm theo từ khóa" id="keywords" name="keywords" type="text">
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <div class="form-group">
                                                <select name="catalog" id="catalog" class="form-control">
                                                    <option>Tìm kiếm theo tác giả</option>
                                                    @if (ViewBag.Authors != null)
                                                    {
                                                        foreach (var author in ViewBag.Authors)
                                                        {
                                                            <option value="@author.AuthorName">@author.AuthorName</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-sm-6">
                                            <div class="form-group">
                                                <select name="category" id="category" class="form-control">
                                                    <option>Tất cả thể loại</option>
                                                    @if (ViewBag.Categories != null)
                                                    {
                                                        foreach (var cat in ViewBag.Categories)
                                                        {
                                                            <option value="@cat.CategoryName">@cat.CategoryName</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-6">
                                            <div class="form-group">
                                                <input class="form-control" type="submit" value="Tìm kiếm">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </section>
                        <!-- End: Search Section -->
                    </div>

                    <div class="booksmedia-detail-box">
                        <div class="detailed-box">
                            <div class="col-xs-12 col-sm-5 col-md-3">
                                <div class="post-thumbnail">
                                    <img src="@Url.Content(Model.CoverImageUrl)" alt="@Model.Title">
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-7 col-md-6">
                                <div class="post-center-content">
                                    <h2>@Model.Title</h2>
                                    <p><strong>Tác giả:</strong> @Model.AuthorNames</p>
                                    <p><strong>ISBN:</strong> @Model.DisplayIsbn</p>
                                    <p><strong>Đánh giá:</strong> </p>
                                    @if (Model.PublishedYear.HasValue)
                                    {
                                        <p><strong>Phiên bản:</strong> Năm @Model.PublishedYear</p>
                                    }
                                    @if (Model.Publisher != null)
                                    {
                                        <p><strong>Nhà xuất bản:</strong> @Model.Publisher.PublisherName</p>
                                    }
                                   
                                    <p><strong>Định dạng:</strong> Sách</p>
                                    @if (Model.Language != null)
                                    {
                                        <p><strong>Ngôn ngữ:</strong> @Model.Language.LanguageName</p>
                                    }
                                    @if (Model.Category != null)
                                    {
                                        <p><strong>Thể loại:</strong> @Model.Category.CategoryName</p>
                                    }
                                    <p><strong>Chủ đề:</strong> @(Model.Category?.CategoryName ?? "Chưa phân loại")</p>
                                    <div class="actions">
                                        <ul>
                                            <li>
                                                <a href="javascript:void(0)" onclick="addToCart(@Model.BookId)" data-toggle="blog-tags" data-placement="top" title="Thêm vào giỏ">
                                                    <i class="fa fa-shopping-cart"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Yêu thích">
                                                    <i class="fa fa-heart"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Gửi email">
                                                    <i class="fa fa-envelope"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Tìm kiếm">
                                                    <i class="fa fa-search"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="In">
                                                    <i class="fa fa-print"></i>
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Chia sẻ">
                                                    <i class="fa fa-share-alt"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-12 col-md-3">
                                <div class="post-right-content">
                                    <h4>Có sẵn ngay</h4>
                                    <p><strong>Tổng số bản sao:</strong> @totalQuantity</p>
                                    <p><strong>Có sẵn:</strong> @availableQuantity</p>
                                    <p><strong>Đang thuê:</strong> @(totalQuantity - availableQuantity)</p>
                                    <p><strong>Hiện có trên kệ tại:</strong> Thư viện chính</p>
                                    <p><strong>Mã kệ:</strong> @(Model.Category?.CategoryName ?? "Chưa phân loại")</p>
                                    <a href="#sectionA" class="available-location">Xem theo vị trí <i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
                                    <button onclick="addToCart(@Model.BookId)" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                                        <i class="fa fa-shopping-cart"></i> Thêm vào giỏ hàng
                                    </button>
                                    <a href="@Url.Action("Create", "Rental", new { area = "Admin" })" class="btn btn-dark-gray" style="width: 100%; margin-bottom: 10px;">Đặt thuê</a>
                                    <a href="#" class="btn btn-dark-gray" style="width: 100%; margin-bottom: 10px;">Xem mẫu</a>
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-dark-gray" style="width: 100%;">Tìm sách tương tự</a>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                        <div class="clearfix"></div>

                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <p><strong>Tóm tắt:</strong> @Model.Description</p>
                        }

                        <div class="table-tabs" id="responsiveTabs">
                            <ul class="nav nav-tabs">
                                <li class="active"><b class="arrow-up"></b><a data-toggle="tab" href="#sectionA">Bản sao: @totalQuantity</a></li>
                                <li><b class="arrow-up"></b><a data-toggle="tab" href="#sectionB">Đánh giá (@reviewCount)</a></li>
                                <li><b class="arrow-up"></b><a data-toggle="tab" href="#sectionC">Mục lục</a></li>
                                <li><b class="arrow-up"></b><a data-toggle="tab" href="#sectionD">Sách đề xuất</a></li>
                            </ul>
                            <div class="tab-content">
                                <div id="sectionA" class="tab-pane fade in active">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Tên thư viện</th>
                                                <th>Số kệ</th>
                                                <th>Loại tài liệu</th>
                                                <th>Trạng thái</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (totalQuantity > 0)
                                            {
                                                var maxRows = Math.Min(totalQuantity, 9);
                                                for (int i = 1; i <= maxRows; i++)
                                                {
                                                    var status = i <= (totalQuantity - availableQuantity) ? "Đang thuê" : (i <= 2 ? "Đang xử lý" : "Có sẵn");
                                                    <tr>
                                                        <td>Thư viện chính</td>
                                                        <td>@(Model.Category?.CategoryName ?? "Chưa phân loại")</td>
                                                        <td>Sách</td>
                                                        <td>@status</td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="4" class="text-center">Chưa có bản sao nào</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div id="sectionB" class="tab-pane fade in">
                                    <h5>Đánh giá</h5>
                                    
                                    @if (reviewCount > 0)
                                    {
                                        <div style="margin-bottom: 30px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                                <div style="font-size: 48px; font-weight: bold; color: #ff7236; margin-right: 20px;">
                                                    @averageRating.ToString("F1")
                                                </div>
                                                <div>
                                                    <div style="font-size: 24px; color: #ffc107; margin-bottom: 5px;">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (i <= (int)averageRating)
                                                            {
                                                                <i class="fa fa-star"></i>
                                                            }
                                                            else if (i - averageRating < 1)
                                                            {
                                                                <i class="fa fa-star-half-o"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="fa fa-star-o"></i>
                                                            }
                                                        }
                                                    </div>
                                                    <div style="color: #666;">
                                                        Dựa trên @reviewCount đánh giá
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }

                                    @if (canReview)
                                    {
                                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                            <h6 style="margin-bottom: 15px;">Viết đánh giá của bạn</h6>
                                            <form id="reviewForm">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="bookId" value="@Model.BookId" />
                                                
                                                <div class="form-group" style="margin-bottom: 15px;">
                                                    <label style="font-weight: bold; margin-bottom: 10px; display: block;">Đánh giá sao <span class="text-danger">*</span></label>
                                                    <div class="star-rating" style="font-size: 24px; color: #ffc107; cursor: pointer;">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <i class="fa fa-star-o" data-rating="@i" style="margin-right: 5px;" onmouseover="highlightStars(@i)" onmouseout="resetStars()" onclick="selectRating(@i)"></i>
                                                        }
                                                    </div>
                                                    <input type="hidden" id="rating" name="rating" value="0" required />
                                                    <small class="text-danger" id="ratingError" style="display: none;">Vui lòng chọn số sao</small>
                                                </div>

                                                <div class="form-group" style="margin-bottom: 15px;">
                                                    <label for="comment" style="font-weight: bold; margin-bottom: 10px; display: block;">Bình luận</label>
                                                    <textarea id="comment" name="comment" class="form-control" rows="4" placeholder="Chia sẻ cảm nhận của bạn về cuốn sách này..." maxlength="1000"></textarea>
                                                    <small class="text-muted">Tối đa 1000 ký tự</small>
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fa fa-paper-plane"></i> Gửi đánh giá
                                                </button>
                                            </form>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(Context.Session?.GetString("UserId")))
                                    {
                                        <div class="alert alert-info" style="margin-bottom: 30px;">
                                            <i class="fa fa-info-circle"></i> Bạn chỉ có thể đánh giá sách đã thuê và trả.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning" style="margin-bottom: 30px;">
                                            <i class="fa fa-exclamation-triangle"></i> Vui lòng <a href="@Url.Action("Login", "Account")">đăng nhập</a> để đánh giá sách.
                                        </div>
                                    }

                                    <div class="reviews-list">
                                        <h6 style="margin-bottom: 20px;">Đánh giá từ độc giả (@reviewCount)</h6>
                                        
                                        @if (reviews.Any())
                                        {
                                            @foreach (var review in reviews)
                                            {
                                                <div style="border-bottom: 1px solid #e9ecef; padding: 20px 0;">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                                        <div>
                                                            <strong style="font-size: 16px;">@review.Customer?.FullName ?? "Khách hàng"</strong>
                                                            <div style="color: #ffc107; font-size: 14px; margin-top: 5px;">
                                                                @for (int i = 1; i <= 5; i++)
                                                                {
                                                                    if (i <= review.Rating)
                                                                    {
                                                                        <i class="fa fa-star"></i>
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="fa fa-star-o"></i>
                                                                    }
                                                                }
                                                                <span style="color: #666; margin-left: 10px;">@review.Rating/5</span>
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">@review.CreatedDate.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(review.Comment))
                                                    {
                                                        <p style="color: #555; margin-top: 10px; line-height: 1.6;">@review.Comment</p>
                                                    }
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="alert alert-info text-center" style="padding: 30px;">
                                                <i class="fa fa-info-circle" style="font-size: 48px; color: #17a2b8; margin-bottom: 15px;"></i>
                                                <p>Chưa có đánh giá nào cho cuốn sách này. Hãy là người đầu tiên đánh giá!</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div id="sectionC" class="tab-pane fade in">
                                    <h5>Mục lục</h5>
                                    @if (!string.IsNullOrEmpty(Model.Description))
                                    {
                                        <p>@Model.Description</p>
                                    }
                                    else
                                    {
                                        <p>Thông tin mục lục đang được cập nhật.</p>
                                    }
                                </div>
                                <div id="sectionD" class="tab-pane fade in">
                                    <h5>Sách đề xuất</h5>
                                    @if (relatedBooks != null && relatedBooks.Any())
                                    {
                                        <p>Dựa trên thể loại và sở thích của bạn, chúng tôi đề xuất những cuốn sách sau:</p>
                                        <div class="row">
                                            @foreach (var relatedBook in relatedBooks.Take(3))
                                            {
                                                <div class="col-md-4">
                                                    <div class="book-item">
                                                        <img src="@Url.Content(relatedBook.CoverImageUrl)" alt="@relatedBook.Title" style="width: 100%; max-height: 200px; object-fit: cover;" />
                                                        <h6><a href="@Url.Action("Detail", "Book", new { id = relatedBook.BookId, alias = Function.TitleSlugGenerationAlias(relatedBook.Title) })">@relatedBook.Title</a></h6>
                                                        <p><strong>Tác giả:</strong> @relatedBook.AuthorNames</p>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p>Chưa có sách đề xuất.</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- End: Products Section -->

@if (relatedBooks != null && relatedBooks.Any())
{
    <div class="booksmedia-fullwidth">
        <div class="container">
            <h2 class="section-title text-center">Sách phổ biến</h2>
            <span class="underline center"></span>
            <p class="lead text-center">Những cuốn sách được yêu thích nhất</p>
            <ul class="popular-items-detail-v2">
                @foreach (var relatedBook in relatedBooks.Take(6))
                {
                    <li>
                        <figure>
                            <img src="@Url.Content(relatedBook.CoverImageUrl)" alt="@relatedBook.Title">
                            <figcaption>
                                <header>
                                    <h4><a href="@Url.Action("Detail", "Book", new { id = relatedBook.BookId, alias = Function.TitleSlugGenerationAlias(relatedBook.Title) })">@relatedBook.Title</a></h4>
                                    <p><strong>Tác giả:</strong> @relatedBook.AuthorNames</p>
                                    <p><strong>ISBN:</strong> @relatedBook.DisplayIsbn</p>
                                </header>
                                <p>@relatedBook.TruncatedDescription</p>
                                <div class="actions">
                                    <ul>
                                        <li>
                                            <a href="javascript:void(0)" onclick="addToCart(@relatedBook.BookId)" data-toggle="blog-tags" data-placement="top" title="Thêm vào giỏ">
                                                <i class="fa fa-shopping-cart"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Yêu thích">
                                                <i class="fa fa-heart"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Gửi email">
                                                <i class="fa fa-envelope"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="@Url.Action("Detail", "Book", new { id = relatedBook.BookId, alias = Function.TitleSlugGenerationAlias(relatedBook.Title) })" target="_blank" data-toggle="blog-tags" data-placement="top" title="Tìm kiếm">
                                                <i class="fa fa-search"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="In">
                                                <i class="fa fa-print"></i>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#" target="_blank" data-toggle="blog-tags" data-placement="top" title="Chia sẻ">
                                                <i class="fa fa-share-alt"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </figcaption>
                        </figure>
                    </li>
                }
            </ul>
        </div>
    </div>
}

@section Scripts {
    <script>
        var selectedRating = 0;

        function highlightStars(rating) {
            $('.star-rating i').each(function(index) {
                if (index < rating) {
                    $(this).removeClass('fa-star-o fa-star-half-o').addClass('fa-star');
                } else {
                    $(this).removeClass('fa-star fa-star-half-o').addClass('fa-star-o');
                }
            });
        }

        function resetStars() {
            if (selectedRating === 0) {
                $('.star-rating i').removeClass('fa-star fa-star-half-o').addClass('fa-star-o');
            } else {
                highlightStars(selectedRating);
            }
        }

        function selectRating(rating) {
            selectedRating = rating;
            $('#rating').val(rating);
            $('#ratingError').hide();
            highlightStars(rating);
        }

        $('#reviewForm').on('submit', function(e) {
            e.preventDefault();
            
            var rating = $('#rating').val();
            if (rating === '0' || rating === '') {
                $('#ratingError').show();
                return;
            }

            var formData = {
                bookId: $('input[name="bookId"]').val(),
                rating: rating,
                comment: $('#comment').val(),
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            };

            $.ajax({
                url: '@Url.Action("SubmitReview", "Book")',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function() {
                    toastr.error('Có lỗi xảy ra khi gửi đánh giá');
                }
            });
        });

        function addToCart(bookId) {
            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: { bookId: bookId },
                success: function (response) {
                    if (response.success) {
                        updateCartCount(response.cartCount);
                        toastr.success(response.message);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function () {
                    toastr.error('Có lỗi xảy ra khi thêm vào giỏ hàng');
                }
            });
        }

        // Hàm updateCartCount được định nghĩa trong _Layout.cshtml
    </script>
}
