@model IEnumerable<QUANLYTHUVIEN.Models.CartItem>

@{
    ViewData["Title"] = "Thanh toán";
    var cartItems = ViewBag.CartItems as IEnumerable<QUANLYTHUVIEN.Models.CartItem> ?? new List<QUANLYTHUVIEN.Models.CartItem>();
    var totalAmount = (decimal)(ViewBag.TotalAmount ?? 0);
    var totalQuantity = (int)(ViewBag.TotalQuantity ?? 0);
}

<!-- Start: Page Banner -->
<section class="page-banner services-banner">
    <div class="container">
        <div class="banner-header">
            <h2>Thanh toán</h2>
            <span class="underline center"></span>
            <p class="lead">Hoàn tất thông tin để đặt thuê sách</p>
        </div>
        <div class="breadcrumb">
            <ul>
                <li><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                <li><a href="@Url.Action("Index", "Cart")">Giỏ hàng</a></li>
                <li>Thanh toán</li>
            </ul>
        </div>
    </div>
</section>
<!-- End: Page Banner -->

<!-- Start: Checkout Section -->
<div id="content" class="site-content">
    <div id="primary" class="content-area">
        <main id="main" class="site-main">
            <div class="books-media-gird">
                <div class="container" style="padding: 60px 15px;">
                    <div class="row">
                        <!-- Checkout Form -->
                        <div class="col-lg-8 col-md-12">
                            <div class="checkout-form-container">
                                <div class="checkout-header">
                                    <h3 class="checkout-title">
                                        <i class="fa fa-user-circle"></i> Thông tin khách hàng
                                    </h3>
                                </div>

                                <form id="checkoutForm" method="post" action="@Url.Action("Process", "Checkout")">
                                    @Html.AntiForgeryToken()

                                    <!-- Personal Information -->
                                    <div class="form-section">
                                        <h4 class="section-title">
                                            <i class="fa fa-id-card"></i> Thông tin cá nhân
                                        </h4>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="fullName" class="form-label">
                                                        Họ và tên <span class="required">*</span>
                                                    </label>
                                                    <input type="text" class="form-control" id="fullName" name="fullName" 
                                                           value="@ViewBag.UserFullName" required 
                                                           placeholder="Nhập họ và tên của bạn">
                                                    <span class="field-error" id="fullName-error"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="email" class="form-label">
                                                        Email <span class="required">*</span>
                                                    </label>
                                                    <input type="email" class="form-control" id="email" name="email" 
                                                           value="@ViewBag.UserEmail" required 
                                                           placeholder="example@email.com">
                                                    <span class="field-error" id="email-error"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="phone" class="form-label">
                                                        Số điện thoại <span class="required">*</span>
                                                    </label>
                                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                                           value="@ViewBag.UserPhone" required 
                                                           placeholder="0123456789">
                                                    <span class="field-error" id="phone-error"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="address" class="form-label">
                                                        Địa chỉ <span class="required">*</span>
                                                    </label>
                                                    <textarea class="form-control" id="address" name="address" rows="3" required 
                                                              placeholder="Nhập địa chỉ nhận sách"></textarea>
                                                    <span class="field-error" id="address-error"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rental Information -->
                                    <div class="form-section">
                                        <h4 class="section-title">
                                            <i class="fa fa-calendar"></i> Thông tin thuê sách
                                        </h4>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="rentalDays" class="form-label">
                                                        Số ngày thuê <span class="required">*</span>
                                                    </label>
                                                    <div class="rental-days-selector">
                                                        <button type="button" class="day-btn" data-days="7">
                                                            <span class="day-number">7</span>
                                                            <span class="day-label">ngày</span>
                                                        </button>
                                                        <button type="button" class="day-btn active" data-days="14">
                                                            <span class="day-number">14</span>
                                                            <span class="day-label">ngày</span>
                                                        </button>
                                                        <button type="button" class="day-btn" data-days="30">
                                                            <span class="day-number">30</span>
                                                            <span class="day-label">ngày</span>
                                                        </button>
                                                        <button type="button" class="day-btn" data-days="custom">
                                                            <span class="day-label">Tùy chọn</span>
                                                        </button>
                                                    </div>
                                                    <input type="number" class="form-control mt-3" id="rentalDays" name="rentalDays" 
                                                           value="14" min="1" max="365" required 
                                                           placeholder="Nhập số ngày thuê" style="display: none;">
                                                    <span class="field-error" id="rentalDays-error"></span>
                                                    <small class="form-text text-muted">
                                                        <i class="fa fa-info-circle"></i> Bạn có thể chọn số ngày thuê từ 1 đến 365 ngày
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Payment Method -->
                                    <div class="form-section">
                                        <h4 class="section-title">
                                            <i class="fa fa-credit-card"></i> Phương thức thanh toán
                                        </h4>
                                        <div class="payment-methods">
                                            <label class="payment-method">
                                                <input type="radio" name="paymentMethod" value="cash" checked>
                                                <div class="payment-card">
                                                    <i class="fa fa-money"></i>
                                                    <span>Thanh toán khi nhận sách</span>
                                                </div>
                                            </label>
                                            <label class="payment-method">
                                                <input type="radio" name="paymentMethod" value="bank">
                                                <div class="payment-card">
                                                    <i class="fa fa-university"></i>
                                                    <span>Chuyển khoản ngân hàng</span>
                                                </div>
                                            </label>
                                            <label class="payment-method">
                                                <input type="radio" name="paymentMethod" value="vnpay">
                                                <div class="payment-card">
                                                    <i class="fa fa-credit-card"></i>
                                                    <span>Cổng thanh toán VNPay</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Notes -->
                                    <div class="form-section">
                                        <h4 class="section-title">
                                            <i class="fa fa-sticky-note"></i> Ghi chú (tùy chọn)
                                        </h4>
                                        <div class="form-group">
                                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                                      placeholder="Ghi chú thêm cho đơn hàng của bạn..."></textarea>
                                        </div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="form-actions">
                                        <a href="@Url.Action("Index", "Cart")" class="btn-back">
                                            <i class="fa fa-arrow-left"></i> Quay lại giỏ hàng
                                        </a>
                                        <button type="submit" class="btn-submit">
                                            <i class="fa fa-check"></i> Xác nhận đặt thuê
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-4 col-md-12">
                            <div class="order-summary-card">
                                <h3 class="summary-title">
                                    <i class="fa fa-shopping-bag"></i> Tóm tắt đơn hàng
                                </h3>
                                <div class="summary-items">
                                    @foreach (var item in cartItems)
                                    {
                                        <div class="summary-item">
                                            <div class="item-image">
                                                <img src="@Url.Content(item.CoverImageUrl)" alt="@item.Title"
                                                     onerror="this.src='@Url.Content("~/images/books-media/gird-view/book-media-grid-01.jpg")'" />
                                            </div>
                                            <div class="item-info">
                                                <h5 class="item-title">@item.Title</h5>
                                                <p class="item-author">@item.AuthorNames</p>
                                                <div class="item-meta">
                                                    <span class="item-quantity">SL: @item.Quantity</span>
                                                    <span class="item-price">@item.DailyRate.ToString("N0") đ/ngày</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="summary-divider"></div>
                                <div class="summary-totals">
                                    <div class="total-row">
                                        <span class="total-label">Số lượng sách:</span>
                                        <span class="total-value" id="summary-quantity">@totalQuantity cuốn</span>
                                    </div>
                                    <div class="total-row">
                                        <span class="total-label">Số ngày thuê:</span>
                                        <span class="total-value" id="summary-days">14 ngày</span>
                                    </div>
                                    <div class="total-row highlight">
                                        <span class="total-label">Tổng tiền:</span>
                                        <span class="total-value" id="summary-total">@totalAmount.ToString("N0") đ</span>
                                    </div>
                                </div>
                                <div class="summary-note">
                                    <i class="fa fa-info-circle"></i>
                                    <small>Tổng tiền sẽ được tính dựa trên số ngày thuê bạn chọn</small>
                                </div>
                            </div>

                            <!-- Security Badge -->
                            <div class="security-badge">
                                <div class="badge-item">
                                    <i class="fa fa-shield"></i>
                                    <span>Bảo mật thông tin</span>
                                </div>
                                <div class="badge-item">
                                    <i class="fa fa-lock"></i>
                                    <span>Thanh toán an toàn</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
<!-- End: Checkout Section -->

<style>
    /* Checkout Form Container */
    .checkout-form-container {
        background: #fff;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 5px 30px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }

    .checkout-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .checkout-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .checkout-title i {
        color: #667eea;
        font-size: 32px;
    }

    /* Form Sections */
    .form-section {
        margin-bottom: 40px;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 15px;
        border-left: 4px solid #667eea;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        margin: 0 0 25px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: #667eea;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .required {
        color: #ff4444;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s ease;
        background: #fff;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .field-error {
        display: block;
        color: #ff4444;
        font-size: 13px;
        margin-top: 5px;
        min-height: 20px;
    }

    /* Rental Days Selector */
    .rental-days-selector {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }

    .day-btn {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .day-btn:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .day-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: #fff;
    }

    .day-number {
        font-size: 24px;
        font-weight: 700;
    }

    .day-label {
        font-size: 12px;
        opacity: 0.8;
    }

    /* Payment Methods */
    .payment-methods {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .payment-method {
        margin: 0;
        cursor: pointer;
    }

    .payment-method input[type="radio"] {
        display: none;
    }

    .payment-card {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
        font-weight: 600;
        color: #666;
    }

    .payment-card i {
        font-size: 24px;
        color: #667eea;
    }

    .payment-method input[type="radio"]:checked + .payment-card {
        border-color: #667eea;
        background: #f0f4ff;
        color: #667eea;
    }

    .payment-method:hover .payment-card {
        border-color: #667eea;
        transform: translateX(5px);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #f0f0f0;
    }

    .btn-back {
        padding: 15px 30px;
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        color: #666;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        border-color: #667eea;
        color: #667eea;
        background: #f0f4ff;
    }

    .btn-submit {
        flex: 1;
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: #fff;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-submit:active {
        transform: translateY(0);
    }

    /* Order Summary */
    .order-summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: #fff;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        position: sticky;
        top: 20px;
    }

    .summary-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 25px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .summary-items {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .summary-items::-webkit-scrollbar {
        width: 6px;
    }

    .summary-items::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
    }

    .summary-items::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.3);
        border-radius: 10px;
    }

    .summary-item {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        margin-bottom: 15px;
    }

    .item-image {
        width: 60px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info {
        flex: 1;
    }

    .item-title {
        font-size: 14px;
        font-weight: 700;
        margin: 0 0 5px 0;
        line-height: 1.4;
    }

    .item-author {
        font-size: 12px;
        opacity: 0.8;
        margin: 0 0 8px 0;
    }

    .item-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        opacity: 0.9;
    }

    .summary-divider {
        height: 2px;
        background: rgba(255,255,255,0.3);
        margin: 20px 0;
    }

    .summary-totals {
        margin-bottom: 20px;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        font-size: 16px;
    }

    .total-row.highlight {
        font-size: 22px;
        font-weight: 700;
        padding-top: 20px;
        border-top: 2px solid rgba(255,255,255,0.3);
    }

    .total-label {
        opacity: 0.9;
    }

    .total-value {
        font-weight: 700;
    }

    .summary-note {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        font-size: 13px;
        line-height: 1.6;
        display: flex;
        gap: 10px;
    }

    .summary-note i {
        margin-top: 2px;
    }

    /* Security Badge */
    .security-badge {
        margin-top: 20px;
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    }

    .badge-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        color: #666;
        font-size: 14px;
    }

    .badge-item:not(:last-child) {
        border-bottom: 1px solid #f0f0f0;
    }

    .badge-item i {
        color: #4caf50;
        font-size: 18px;
    }

    /* Responsive */
    @@media (max-width: 991px) {
        .checkout-form-container {
            padding: 25px;
        }

        .order-summary-card {
            position: relative;
            margin-top: 30px;
        }

        .rental-days-selector {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 767px) {
        .checkout-form-container {
            padding: 20px;
        }

        .form-section {
            padding: 20px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn-back,
        .btn-submit {
            width: 100%;
        }

        .rental-days-selector {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Rental days selector
            $('.day-btn').click(function() {
                $('.day-btn').removeClass('active');
                $(this).addClass('active');
                
                var days = $(this).data('days');
                if (days === 'custom') {
                    $('#rentalDays').show().focus();
                } else {
                    $('#rentalDays').hide().val(days);
                    updateSummary();
                }
            });

            // Update summary when rental days change
            $('#rentalDays').on('input', function() {
                updateSummary();
            });

            // Form validation
            $('#checkoutForm').on('submit', function(e) {
                var isValid = true;
                
                // Clear previous errors
                $('.field-error').text('');
                $('.form-control').removeClass('error');
                
                // Validate fullName
                if (!$('#fullName').val().trim()) {
                    $('#fullName-error').text('Vui lòng nhập họ và tên');
                    $('#fullName').addClass('error');
                    isValid = false;
                }
                
                // Validate email
                var email = $('#email').val().trim();
                if (!email) {
                    $('#email-error').text('Vui lòng nhập email');
                    $('#email').addClass('error');
                    isValid = false;
                } else if (!isValidEmail(email)) {
                    $('#email-error').text('Email không hợp lệ');
                    $('#email').addClass('error');
                    isValid = false;
                }
                
                // Validate phone
                if (!$('#phone').val().trim()) {
                    $('#phone-error').text('Vui lòng nhập số điện thoại');
                    $('#phone').addClass('error');
                    isValid = false;
                }
                
                // Validate address
                if (!$('#address').val().trim()) {
                    $('#address-error').text('Vui lòng nhập địa chỉ');
                    $('#address').addClass('error');
                    isValid = false;
                }
                
                // Validate rental days
                var days = parseInt($('#rentalDays').val());
                if (!days || days < 1) {
                    $('#rentalDays-error').text('Vui lòng chọn số ngày thuê');
                    $('#rentalDays').addClass('error');
                    isValid = false;
                }
                
                // Debug: Log payment method
                var paymentMethod = $('input[name="paymentMethod"]:checked').val();
                console.log('Payment Method:', paymentMethod);
                console.log('Form valid:', isValid);
                
                if (!isValid) {
                    e.preventDefault();
                    toastr.error('Vui lòng điền đầy đủ thông tin');
                    return false;
                } else {
                    console.log('Form is valid, submitting...');
                    // Show loading indicator
                    $('.btn-submit').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang xử lý...');
                    // Allow form to submit normally
                    return true;
                }
            });

            function isValidEmail(email) {
                var re = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                return re.test(email);
            }

            function updateSummary() {
                var days = parseInt($('#rentalDays').val()) || 14;
                var totalAmount = @totalAmount;
                var totalQuantity = @totalQuantity;
                
                // Calculate total based on rental days
                // Each item's daily rate * quantity * days
                var calculatedTotal = 0;
                @foreach (var item in cartItems)
                {
                    <text>
                    calculatedTotal += @item.DailyRate * @item.Quantity * days;
                    </text>
                }
                
                $('#summary-days').text(days + ' ngày');
                $('#summary-total').text(calculatedTotal.toLocaleString('vi-VN') + ' đ');
            }

            // Initialize summary
            updateSummary();
        });
    </script>
}

