@model IEnumerable<QUANLYTHUVIEN.Models.Book>
@using QUANLYTHUVIEN.Utilities

<div id="category-filter">
    <ul class="category-list">
        @foreach (var item in Model)
        {
            string categoryTag = "unknown";
            if (item.Category != null && !string.IsNullOrEmpty(item.Category.CategoryName))
            {
                categoryTag = item.Category.CategoryName.ToLower()
                .Replace(" & ", "-")
                .Replace(" ", "-");
            }
            
            var bookAlias = Function.TitleSlugGenerationAlias(item.Title);

            <li class="category-item books @categoryTag">
                <figure>
                    <img src="@Url.Content(item.CoverImageUrl)" alt="@item.Title" />
                    <figcaption class="bg-orange">
                        <div class="info-block">
                            <h4><a href="@Url.Action("Detail", "Book", new { id = item.BookId, alias = bookAlias })" style="color: inherit; text-decoration: none;">@item.Title</a></h4>
                            <span class="author">
                                <strong>Author:</strong>
                                @item.AuthorNames
                            </span>
                            <span class="author">
                                <strong>ISBN:</strong>
                                @item.DisplayIsbn
                            </span>
                            <div class="rating">
                                <span>☆</span><span>☆</span><span>☆</span><span>☆</span><span>☆</span>
                            </div>
                            <p>@item.TruncatedDescription</p>
                            <a href="@Url.Action("Detail", "Book", new { id = item.BookId, alias = bookAlias })">Đọc thêm <i class="fa fa-long-arrow-right"></i></a>
                            <ol>
                                <li><a href="javascript:void(0)" onclick="addToCart(@item.BookId)" title="Thêm vào giỏ hàng"><i class="fa fa-shopping-cart"></i></a></li>
                                <li><a href="#" title="Yêu thích"><i class="fa fa-heart"></i></a></li>
                                <li><a href="mailto:?subject=@item.Title" title="Gửi email"><i class="fa fa-envelope"></i></a></li>
                                <li><a href="javascript:void(0)" onclick="shareBook(@item.BookId, '@item.Title.Replace("'", "\\'")')" title="Chia sẻ"><i class="fa fa-share-alt"></i></a></li>
                                <li><a href="@Url.Action("Detail", "Book", new { id = item.BookId, alias = bookAlias })" title="Xem chi tiết"><i class="fa fa-search"></i></a></li>
                            </ol>
                        </div>
                    </figcaption>
                </figure>
            </li>
        }
    </ul>

    <div class="center-content">

        <a href="@Url.Action("Index", "Book")" id="btn-xem-them" class="btn btn-primary">Xem thêm</a>

    </div>
    <div class="clearfix"></div>
</div>

<script>
    // Hàm addToCart được định nghĩa trong _Layout.cshtml
    // Nếu chưa có, thêm vào đây
    if (typeof addToCart === 'undefined') {
        function addToCart(bookId) {
            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: { bookId: bookId },
                success: function (response) {
                    if (response.success) {
                        if (typeof updateCartCount === 'function') {
                            updateCartCount(response.cartCount);
                        }
                        if (typeof toastr !== 'undefined') {
                            toastr.success(response.message);
                        } else {
                            alert(response.message);
                        }
                    } else {
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.message);
                        } else {
                            alert(response.message);
                        }
                    }
                },
                error: function () {
                    if (typeof toastr !== 'undefined') {
                        toastr.error('Có lỗi xảy ra khi thêm vào giỏ hàng');
                    } else {
                        alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
                    }
                }
            });
        }
    }
    
    function shareBook(bookId, title) {
        // Tạo alias từ title (giống như trong controller)
        var alias = title.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        var baseUrl = window.location.origin;
        var url = baseUrl + '/book/' + alias + '-' + bookId + '.html';
        if (navigator.share) {
            navigator.share({
                title: title,
                text: 'Xem cuốn sách này: ' + title,
                url: url
            }).catch(function(error) {
                console.log('Error sharing', error);
            });
        } else {
            // Fallback: copy to clipboard
            var textArea = document.createElement("textarea");
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            if (typeof toastr !== 'undefined') {
                toastr.success('Đã copy link vào clipboard!');
            } else {
                alert('Đã copy link vào clipboard!');
            }
        }
    }
</script>